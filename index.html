<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer Graphics Learning Studio</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- External Libraries - Load these BEFORE our scripts -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/controls/PointerLockControls.js"></script>
    <style>
        #debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        #debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 1001;
        }
        #loading-progress {
            width: 80%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        #loading-status {
            margin-top: 10px;
            font-style: italic;
            color: #ccc;
        }
        #error-message {
            color: #ff6b6b;
            margin-top: 10px;
            display: none;
        }
        .control-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .control-button {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .control-button:hover {
            background: #3e8e41;
        }
        #emergency-start {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 9999;
            font-weight: bold;
        }
        #function-status {
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #ccc;
            text-align: left;
            max-height: 100px;
            overflow-y: auto;
        }
        #pointer-lock-bypass {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 9999;
            font-weight: bold;
        }
        #pointer-lock-status {
            position: fixed;
            top: 60px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9998;
        }
    </style>
</head>
<body>
    <!-- Emergency start button that's always visible -->
    <button id="emergency-start">EMERGENCY START</button>
    
    <!-- Pointer lock bypass button -->
    <button id="pointer-lock-bypass">FORCE POINTER LOCK</button>
    <div id="pointer-lock-status">Pointer Lock: Waiting</div>

    <div id="loading-screen">
        <div class="loader"></div>
        <h2>Loading Graphics Studio...</h2>
        <p>Preparing 3D environment and learning materials</p>
        <div id="loading-progress">
            <div id="progress-bar"></div>
        </div>
        <div id="loading-status">Initializing...</div>
        <div id="error-message"></div>
        <div id="function-status"></div>
        <div class="control-buttons">
            <button id="skip-loading" class="control-button">Skip Loading</button>
            <button id="reload-page" class="control-button">Reload Page</button>
            <button id="check-functions" class="control-button">Check Functions</button>
        </div>
    </div>

    <div id="instructions" style="display: none;">
        <div class="instruction-content">
            <h1>Computer Graphics Learning Studio</h1>
            <p>Explore a 3D world to learn about computer graphics concepts</p>
            <ul>
                <li>Move: WASD or Arrow Keys</li>
                <li>Look: Mouse</li>
                <li>Jump: Space</li>
                <li>Interact: Approach learning stations</li>
                <li>Toggle Info: Tab key or 'i' button</li>
                <li>Exit: 'ESC'</li>
            </ul>
            <p class="click-instruction">Click anywhere to begin</p>
            <button id="start-experience" class="control-button" style="margin-top: 20px;">START EXPERIENCE</button>
        </div>
    </div>

    <div id="canvas-container">
        <!-- Three.js will render here -->
    </div>

    <div class="info-panel">
        <!-- Info messages will appear here -->
    </div>

    <div id="ui-panel">
        <h1>Graphics Learning Studio</h1>
        <div id="main-content">
            <p>Welcome to the Computer Graphics Learning Studio! This interactive environment helps you understand fundamental concepts in computer graphics.</p>
            <p>Explore the 3D world to discover learning stations about different topics.</p>
            
            <div class="control-group">
                <h2>Current Topic: <span id="current-topic">Explore</span></h2>
                <div id="topic-description">
                    <p>Move around the 3D world to discover learning stations about computer graphics concepts.</p>
                </div>
            </div>
            
            <div class="control-group">
                <h2>Controls</h2>
                <p>• Move: WASD or Arrow Keys</p>
                <p>• Look: Mouse</p>
                <p>• Jump: Space</p>
                <p>• Exit: ESC</p>
                <p>• Toggle Info: Tab key or 'i' button</p>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <button id="debug-toggle">Debug</button>
    <div id="debug-panel" style="display: none;">
        <h3>Debug Information</h3>
        <div id="debug-info">Loading...</div>
        <div style="margin-top: 10px;">
            <button id="force-start" class="control-button">Force Start</button>
            <button id="reset-camera" class="control-button">Reset Camera</button>
            <button id="check-functions-debug" class="control-button">Check Functions</button>
        </div>
    </div>
    
    <!-- Application Scripts - Order matters for dependencies -->
    <!-- Load scripts with explicit onload handlers to ensure proper loading -->
    <script>
        // Track script loading status
        window.scriptStatus = {
            ui: false,
            world: false,
            firstPersonControls: false,
            main: false
        };
        
        // Function to check if all required functions are available
        window.checkRequiredFunctions = function() {
            const functionStatus = document.getElementById('function-status');
            if (!functionStatus) return;
            
            let statusHTML = '<h4>Function Status:</h4>';
            
            // Check UI functions
            statusHTML += 'UI.js: ' + (window.scriptStatus.ui ? '✓' : '✗') + '<br>';
            statusHTML += '- updateStationInfo: ' + (typeof updateStationInfo === 'function' ? '✓' : '✗') + '<br>';
            
            // Check World functions
            statusHTML += 'World.js: ' + (window.scriptStatus.world ? '✓' : '✗') + '<br>';
            statusHTML += '- createWorld: ' + (typeof createWorld === 'function' ? '✓' : '✗') + '<br>';
            statusHTML += '- createSkybox: ' + (typeof createSkybox === 'function' ? '✓' : '✗') + '<br>';
            statusHTML += '- createTerrain: ' + (typeof createTerrain === 'function' ? '✓' : '✗') + '<br>';
            statusHTML += '- checkStationProximity: ' + (typeof checkStationProximity === 'function' ? '✓' : '✗') + '<br>';
            
            // Check FirstPersonControls functions
            statusHTML += 'FirstPersonControls.js: ' + (window.scriptStatus.firstPersonControls ? '✓' : '✗') + '<br>';
            statusHTML += '- initFirstPersonControls: ' + (typeof initFirstPersonControls === 'function' ? '✓' : '✗') + '<br>';
            statusHTML += '- updateFirstPersonControls: ' + (typeof updateFirstPersonControls === 'function' ? '✓' : '✗') + '<br>';
            
            // Check Main functions
            statusHTML += 'Main.js: ' + (window.scriptStatus.main ? '✓' : '✗') + '<br>';
            statusHTML += '- init: ' + (typeof init === 'function' ? '✓' : '✗') + '<br>';
            statusHTML += '- animate: ' + (typeof animate === 'function' ? '✓' : '✗') + '<br>';
            
            functionStatus.innerHTML = statusHTML;
            console.log('Function check completed');
        };
        
        // Create script loading function
        function loadScript(src, onload, id) {
            const script = document.createElement('script');
            script.src = src;
            script.id = id;
            script.onload = function() {
                console.log(`Script loaded: ${src}`);
                if (onload) onload();
            };
            script.onerror = function() {
                console.error(`Error loading script: ${src}`);
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = `Failed to load script: ${src}`;
                    errorElement.style.display = 'block';
                }
            };
            document.body.appendChild(script);
        }
        
        // Load scripts in sequence to ensure proper dependency order
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM content loaded, loading scripts sequentially');
            
            // Load UI.js first
            loadScript('js/ui.js', function() {
                console.log('UI.js loaded');
                window.scriptStatus.ui = true;
                
                // Then load World.js
                loadScript('js/world.js', function() {
                    console.log('World.js loaded');
                    window.scriptStatus.world = true;
                    
                    // Check if createWorld is defined
                    if (typeof createWorld !== 'function') {
                        console.error('createWorld function not defined after loading world.js');
                    } else {
                        console.log('createWorld function is available');
                    }
                    
                    // Then load FirstPersonControls.js
                    loadScript('js/firstPersonControls.js', function() {
                        console.log('FirstPersonControls.js loaded');
                        window.scriptStatus.firstPersonControls = true;
                        
                        // Finally load Main.js
                        loadScript('js/main.js', function() {
                            console.log('Main.js loaded');
                            window.scriptStatus.main = true;
                            
                            // Check all required functions
                            window.checkRequiredFunctions();
                            
                            // Call init() now that all scripts are loaded
                            if (typeof init === 'function') {
                                console.log('Calling init()...');
                                init();
                            } else {
                                console.error('init function not found after loading main.js!');
                                showError('Core initialization function failed to load.');
                            }
                        }, 'main-script');
                    }, 'controls-script');
                }, 'world-script');
            }, 'ui-script');
            
            // Check if THREE is available
            if (typeof THREE === 'undefined') {
                showError('THREE.js library failed to load. Please check your internet connection and try again.');
                return;
            }
            
            console.log('THREE available:', typeof THREE !== 'undefined');
            console.log('PointerLockControls available:', 
                typeof THREE !== 'undefined' && typeof THREE.PointerLockControls !== 'undefined');
            
            // Simulate loading progress
            simulateLoading();
            
            // Add skip loading button functionality
            document.getElementById('skip-loading').addEventListener('click', function() {
                console.log('Skip loading button clicked');
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('instructions').style.display = 'flex';
            });
            
            // Add reload page button functionality
            document.getElementById('reload-page').addEventListener('click', function() {
                window.location.reload();
            });
            
            // Add check functions button functionality
            document.getElementById('check-functions').addEventListener('click', function() {
                window.checkRequiredFunctions();
            });
            
            // Emergency start button
            document.getElementById('emergency-start').addEventListener('click', function() {
                console.log('Emergency start button clicked');
                
                // Hide all UI elements
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('instructions').style.display = 'none';
                
                // Force initialization
                if (!window.appInitialized) {
                    console.log('Emergency initialization');
                    
                    // Clear any existing canvas container
                    const container = document.getElementById('canvas-container');
                    if (container) {
                        container.innerHTML = '';
                    }
                    
                    // Initialize the app
                    if (typeof init === 'function') {
                        init();
                    } else {
                        console.error('Init function not found for emergency start');
                        showError('Init function not found. Try reloading the page.');
                        return;
                    }
                }
                
                // Wait a moment for initialization to complete
                setTimeout(function() {
                    console.log('Emergency pointer lock attempt');
                    forcePointerLock();
                }, 500);
            });
            
            // Pointer lock bypass button
            document.getElementById('pointer-lock-bypass').addEventListener('click', function() {
                console.log('Force pointer lock button clicked');
                forcePointerLock();
            });
            
            // Start experience button in instructions
            const startExperienceButton = document.getElementById('start-experience');
            if (startExperienceButton) {
                startExperienceButton.addEventListener('click', function() {
                    console.log('Start experience button clicked');
                    document.getElementById('instructions').style.display = 'none';
                    forcePointerLock();
                });
            }
            
            // Function to force pointer lock
            function forcePointerLock() {
                updatePointerLockStatus('Attempting force lock...');
                
                // Make sure the app is initialized first
                if (!window.appInitialized) {
                    console.log('App not initialized yet, initializing now...');
                    if (typeof init === 'function') {
                        init();
                    }
                    
                    // Wait for initialization to complete
                    document.addEventListener('appInitialized', function() {
                        console.log('App initialized event received, now trying pointer lock');
                        attemptPointerLock();
                    }, { once: true });
                    
                    return;
                }
                
                attemptPointerLock();
            }
            
            // Attempt to get pointer lock using various methods
            function attemptPointerLock() {
                // Try different methods to get pointer lock
                if (typeof window.controls !== 'undefined' && window.controls && window.controls.lock) {
                    try {
                        window.controls.lock();
                        console.log('Requested pointer lock via controls.lock()');
                    } catch (error) {
                        console.error('Error requesting pointer lock via controls:', error);
                        tryDirectPointerLock();
                    }
                } else {
                    console.log('Controls not available, trying direct pointer lock');
                    tryDirectPointerLock();
                }
            }
            
            // Try to get pointer lock directly on the canvas
            function tryDirectPointerLock() {
                // Get the canvas using our helper function
                const canvas = typeof getCanvas === 'function' ? getCanvas() : document.querySelector('canvas');
                
                if (canvas) {
                    console.log('Canvas found:', canvas);
                    try {
                        if (canvas.requestPointerLock) {
                            canvas.requestPointerLock();
                            console.log('Requested pointer lock directly on canvas');
                        } else {
                            console.error('requestPointerLock not available on canvas');
                            showPointerLockError('Browser does not support Pointer Lock API');
                        }
                    } catch (error) {
                        console.error('Error requesting direct pointer lock:', error);
                        showPointerLockError(error.message || 'Unknown error');
                    }
                } else {
                    console.error('Canvas element not found');
                    showPointerLockError('Canvas not found - try the Emergency Start button');
                }
            }
            
            // Show pointer lock error message
            function showPointerLockError(message) {
                updatePointerLockStatus('Error: ' + message);
                
                // Show error in the error message area
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = 'Pointer Lock Error: ' + message;
                    errorElement.style.display = 'block';
                }
            }
            
            // Update pointer lock status display
            function updatePointerLockStatus(status) {
                const statusElement = document.getElementById('pointer-lock-status');
                if (statusElement) {
                    statusElement.textContent = 'Pointer Lock: ' + status;
                }
            }
            
            // Listen for pointer lock change
            document.addEventListener('pointerlockchange', function() {
                if (document.pointerLockElement) {
                    updatePointerLockStatus('Locked');
                    console.log('Pointer lock acquired via pointerlockchange event');
                } else {
                    updatePointerLockStatus('Unlocked');
                    console.log('Pointer lock released via pointerlockchange event');
                }
            });
            
            // Listen for pointer lock error
            document.addEventListener('pointerlockerror', function(event) {
                updatePointerLockStatus('Error: ' + (event.message || 'Unknown error'));
                console.error('Pointer lock error:', event);
            });
            
            // Debug panel toggle
            document.getElementById('debug-toggle').addEventListener('click', function() {
                const debugPanel = document.getElementById('debug-panel');
                if (debugPanel.style.display === 'none') {
                    debugPanel.style.display = 'block';
                    updateDebugInfo();
                } else {
                    debugPanel.style.display = 'none';
                }
            });
            
            // Force start button
            document.getElementById('force-start').addEventListener('click', function() {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('instructions').style.display = 'none';
                forcePointerLock();
            });
            
            // Reset camera button
            document.getElementById('reset-camera').addEventListener('click', function() {
                if (typeof camera !== 'undefined') {
                    camera.position.set(0, 5, 20);
                    camera.lookAt(0, 0, 0);
                    console.log('Camera reset to position:', camera.position);
                }
            });
            
            // Check functions button in debug panel
            document.getElementById('check-functions-debug').addEventListener('click', function() {
                window.checkRequiredFunctions();
                
                // Also update debug info with function status
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    let info = debugInfo.innerHTML;
                    info += '<br><br><strong>Function Status:</strong><br>';
                    info += 'createWorld: ' + (typeof createWorld === 'function' ? '✓' : '✗') + '<br>';
                    info += 'initFirstPersonControls: ' + (typeof initFirstPersonControls === 'function' ? '✓' : '✗') + '<br>';
                    debugInfo.innerHTML = info;
                }
            });
            
            // Update debug info periodically
            function updateDebugInfo() {
                if (document.getElementById('debug-panel').style.display === 'none') return;
                
                const debugInfo = document.getElementById('debug-info');
                let info = '';
                
                // Check if key objects exist
                info += 'THREE: ' + (typeof THREE !== 'undefined' ? '✓' : '✗') + '<br>';
                info += 'PointerLockControls: ' + (typeof THREE !== 'undefined' && typeof THREE.PointerLockControls !== 'undefined' ? '✓' : '✗') + '<br>';
                info += 'scene: ' + (typeof scene !== 'undefined' ? '✓' : '✗') + '<br>';
                info += 'camera: ' + (typeof camera !== 'undefined' ? '✓' : '✗') + '<br>';
                info += 'controls: ' + (typeof controls !== 'undefined' ? '✓' : '✗') + '<br>';
                info += 'renderer: ' + (typeof renderer !== 'undefined' ? '✓' : '✗') + '<br>';
                
                // Script loading status
                info += '<br><strong>Script Loading:</strong><br>';
                info += 'UI.js: ' + (window.scriptStatus.ui ? '✓' : '✗') + '<br>';
                info += 'World.js: ' + (window.scriptStatus.world ? '✓' : '✗') + '<br>';
                info += 'FirstPersonControls.js: ' + (window.scriptStatus.firstPersonControls ? '✓' : '✗') + '<br>';
                info += 'Main.js: ' + (window.scriptStatus.main ? '✓' : '✗') + '<br>';
                
                // Camera position if available
                if (typeof camera !== 'undefined') {
                    info += '<br><strong>Camera position:</strong><br>';
                    info += 'X: ' + camera.position.x.toFixed(2) + '<br>';
                    info += 'Y: ' + camera.position.y.toFixed(2) + '<br>';
                    info += 'Z: ' + camera.position.z.toFixed(2) + '<br>';
                }
                
                // Pointer lock status
                info += '<br>Pointer locked: ' + (document.pointerLockElement ? 'Yes' : 'No') + '<br>';
                
                // Scene children count
                if (typeof scene !== 'undefined') {
                    info += '<br>Objects in scene: ' + scene.children.length + '<br>';
                }
                
                debugInfo.innerHTML = info;
                
                setTimeout(updateDebugInfo, 500);
            }
            
            // Simulate loading progress
            function simulateLoading() {
                const progressBar = document.getElementById('progress-bar');
                const loadingStatus = document.getElementById('loading-status');
                let progress = 0;
                
                const interval = setInterval(function() {
                    progress += 5;
                    if (progress > 100) {
                        clearInterval(interval);
                        return;
                    }
                    
                    progressBar.style.width = progress + '%';
                    
                    if (progress === 20) {
                        loadingStatus.textContent = 'Loading 3D environment...';
                    } else if (progress === 40) {
                        loadingStatus.textContent = 'Preparing textures...';
                    } else if (progress === 60) {
                        loadingStatus.textContent = 'Setting up controls...';
                    } else if (progress === 80) {
                        loadingStatus.textContent = 'Creating learning stations...';
                    } else if (progress === 100) {
                        loadingStatus.textContent = 'Ready!';
                        // Try to hide loading screen after progress is complete
                        setTimeout(function() {
                            const loadingScreen = document.getElementById('loading-screen');
                            if (loadingScreen && loadingScreen.style.display !== 'none') {
                                console.log('Hiding loading screen after progress completion');
                                loadingScreen.style.display = 'none';
                            }
                        }, 1000);
                    }
                }, 100);
            }
            
            // Show error message
            function showError(message) {
                const errorElement = document.getElementById('error-message');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.backgroundColor = '#ff6b6b';
            }
        });
    </script>
</body>
</html> 